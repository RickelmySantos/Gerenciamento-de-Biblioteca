version: "3.8"

services:
  postgres-local:
    image: postgres
    container_name: postgres-local-biblioteca
    volumes:
      - ./infra/postgres/scripts:/docker-entrypoint-initdb.d
      - ./infra/postgres/data:/tmp/data
      - ./.app/data/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_EXTRA_SCHEMAS: keycloak,srh2
      POSTGRES_DB: localdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"

    healthcheck:
      test: "pg_isready --username=postgres && psql --username=postgres --list"
      interval: 5s
      timeout: 10s
      retries: 20
    networks:
      - local-network

  keycloak-local:
    image: bitnami/keycloak:19.0.3
    container_name: keycloak-local-biblioteca
    volumes:
      - ./infra/keycloak/import:/import
      - ./infra/keycloak/scripts:/docker-entrypoint-initdb.d
    environment:
      KEYCLOAK_CREATE_ADMIN_USER: true
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KEYCLOAK_DATABASE_VENDOR: postgresql
      KEYCLOAK_DATABASE_HOST: postgres-local
      KEYCLOAK_DATABASE_PORT: 5432
      KEYCLOAK_DATABASE_NAME: localdb
      KEYCLOAK_DATABASE_USER: postgres
      KEYCLOAK_DATABASE_PASSWORD: postgres
      KEYCLOAK_DATABASE_SCHEMA: keycloak
      KEYCLOAK_LOG_LEVEL: error
      KEYCLOAK_HTTP_RELATIVE_PATH: /auth
      KEYCLOAK_EXTRA_ARGS: -Dkeycloak.profile.feature.scripts=enabled
    ports:
      - "8280:8080"
    depends_on:
      postgres-local:
        condition: service_healthy
    networks:
      - local-network

  biblioteca-api:
    image: biblioteca-api
    build:
      context: biblioteca-api
      dockerfile: Dockerfile.backend
    container_name: biblioteca-api-local
    profiles:
      - "app"
    environment:
      AMBIENTE: local
      BASE_URL: http://localhost:8080
      API_URL: http://localhost:8080/api
      DEFAULT_TIMEZONE: America/Belem
      DEFAULT_LOCALE: pt-BR
      LOGGING_LEVEL: debug

      DB_DRIVER_CLASS_NAME: org.postgresql.Driver
      JPA_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      DB_URL: jdbc:postgresql://postgres-local:5432/localdb
      DB_SCHEMA: biblioteca
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      JPA_SHOW_SQL: true

      FLYWAY_ENABLED: true
      FLYWAY_CREATE_SCHEMA: true
      FLYWAY_DEFAULT_SCHEMA: biblioteca_adm
      FLYWAY_SCHEMAS: biblioteca,biblioteca_adm
      FLYWAY_LOCATIONS: filesystem:/tmp/import

      OAUTH_RESOURCESERVER_JWT: http://localhost:8280/auth/realms/REALM_LOCAL/protocol/openid-connect/certs
      OAUTH_CLIENT_ID: biblioteca-ui

    ports:
      - "8080:8080"
    volumes:
      - ./infra/biblioteca/api/db/migration:/tmp/import
      # - ./infra/biblioteca/api/db/migration/V0:/tmp/import/V0
    depends_on:
      postgres-local:
        condition: service_healthy
    networks:
      - local-network

networks:
  local-network:
    name: local-network
